---

title: core


keywords: fastai
sidebar: home_sidebar

summary: "Unpack and load the [AMASS][] dataset for training with a PyTorch iterator."
description: "Unpack and load the [AMASS][] dataset for training with a PyTorch iterator."
nb_path: "00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Unpack-Tar-Files">Unpack Tar Files<a class="anchor-link" href="#Unpack-Tar-Files"> </a></h1><blockquote><p>Console script to unpack all tar files found in a specified directory and put them in another directory, then create a symlink to be able to find the unpacked data later</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Checksum-Directories">Checksum Directories<a class="anchor-link" href="#Checksum-Directories"> </a></h2><blockquote><p>Checksum directories to only unpack tar files when target directory either doesn't exist or has been incorrectly unpacked.</p>
</blockquote>
<p>It would probably be sufficient to check if the target directory exists, but this is more thorough.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="md5_update_from_file" class="doc_header"><code>md5_update_from_file</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L17" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>md5_update_from_file</code>(<strong><code>filename</code></strong>:<code>Union</code>[<code>str</code>, <code>Path</code>], <strong><code>hash</code></strong>:<code>HASH</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="md5_file" class="doc_header"><code>md5_file</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L25" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>md5_file</code>(<strong><code>filename</code></strong>:<code>Union</code>[<code>str</code>, <code>Path</code>])</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="md5_update_from_dir" class="doc_header"><code>md5_update_from_dir</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L29" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>md5_update_from_dir</code>(<strong><code>directory</code></strong>:<code>Union</code>[<code>str</code>, <code>Path</code>], <strong><code>hash</code></strong>:<code>HASH</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="md5_dir" class="doc_header"><code>md5_dir</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L40" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>md5_dir</code>(<strong><code>directory</code></strong>:<code>Union</code>[<code>str</code>, <code>Path</code>])</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parallel-Unpacking-with-Joblib">Parallel Unpacking with Joblib<a class="anchor-link" href="#Parallel-Unpacking-with-Joblib"> </a></h2><blockquote><p>Unpacks tar files in multiple jobs to speed up unpacking the dataset.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="lazy_unpack" class="doc_header"><code>lazy_unpack</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L122" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>lazy_unpack</code>(<strong><code>tarpath</code></strong>, <strong><code>outdir</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="unpack_body_models" class="doc_header"><code>unpack_body_models</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L145" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>unpack_body_models</code>(<strong><code>tardir</code></strong>, <strong><code>outdir</code></strong>, <strong><code>n_jobs</code></strong>=<em><code>1</code></em>, <strong><code>verify</code></strong>=<em><code>False</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="fast_amass_unpack" class="doc_header"><code>fast_amass_unpack</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L159" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fast_amass_unpack</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">unpack_archive</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">llamass.tqdm</span> <span class="kn">import</span> <span class="n">ProgressParallel</span>


<span class="k">def</span> <span class="nf">lazy_unpack</span><span class="p">(</span><span class="n">tarpath</span><span class="p">,</span> <span class="n">outdir</span><span class="p">):</span>
    <span class="c1"># check if this has already been unpacked by looking for hash file</span>
    <span class="n">tarpath</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tarpath</span><span class="p">),</span> <span class="n">Path</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
    <span class="n">unpacks_to</span> <span class="o">=</span> <span class="n">hashes</span><span class="p">[</span><span class="n">tarpath</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;unpacks_to&quot;</span><span class="p">]</span>
    <span class="n">hashpath</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">unpacks_to</span> <span class="o">+</span> <span class="s2">&quot;.hash&quot;</span><span class="p">)</span>
    <span class="c1"># if the hash exists and it&#39;s correct then assume the directory is correctly unpacked</span>
    <span class="k">if</span> <span class="n">hashpath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hashpath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># read hash</span>
        <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="n">hashes</span><span class="p">[</span><span class="n">tarpath</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;hash&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if there&#39;s no stored hash or it doesn&#39;t match, unpack the tar file</span>
        <span class="n">unpack_archive</span><span class="p">(</span><span class="n">tarpath</span><span class="p">,</span> <span class="n">outdir</span><span class="p">)</span>
        <span class="c1"># calculate the hash of the unpacked directory and check it&#39;s the same</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">md5_dir</span><span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="n">unpacks_to</span><span class="p">)</span>
        <span class="n">_h</span> <span class="o">=</span> <span class="n">hashes</span><span class="p">[</span><span class="n">tarpath</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;hash&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">h</span> <span class="o">==</span> <span class="n">_h</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">outdir</span><span class="o">/</span><span class="n">unpacks_to</span><span class="si">}</span><span class="s2"> hash </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">_h</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># save the calculated hash</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hashpath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">unpack_body_models</span><span class="p">(</span><span class="n">tardir</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">tar_root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tarfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tardir</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tarfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tarfiles</span> <span class="k">if</span> <span class="s2">&quot;tar&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span>
    <span class="n">tarpaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tar_root</span><span class="p">,</span> <span class="n">tar</span><span class="p">)</span> <span class="k">for</span> <span class="n">tar</span> <span class="ow">in</span> <span class="n">tarfiles</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tarpath</span> <span class="ow">in</span> <span class="n">tarpaths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tarpath</span><span class="si">}</span><span class="s2"> extracting to </span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="n">lazy_unpack</span> <span class="k">if</span> <span class="n">verify</span> <span class="k">else</span> <span class="n">unpack_archive</span>
    <span class="n">ProgressParallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)(</span>
        <span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">unpack</span><span class="p">)(</span><span class="n">tarpath</span><span class="p">,</span> <span class="n">outdir</span><span class="p">)</span> <span class="k">for</span> <span class="n">tarpath</span> <span class="ow">in</span> <span class="n">tarpaths</span><span class="p">),</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tarpaths</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">fast_amass_unpack</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unpack all the body model tar files in a directory to a target directory&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;tardir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory containing tar.bz2 body model files&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;outdir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output directory&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--verify&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Verify the output by calculating a checksum, &quot;</span>
        <span class="s2">&quot;ensures that each tar file will only be unpacked once.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-n&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of jobs to run the tar unpacking with&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tardir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verify</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test unpacking the sample data always yields the same result:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="c1"># https://stackoverflow.com/a/3431838/6937913</span>
<span class="k">def</span> <span class="nf">md5</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="n">hash_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">hash_md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hash_md5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="n">md5sums</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;amass_sample.npz&quot;</span><span class="p">:</span> <span class="s2">&quot;d0b546b3619c8579ade39e3a8ccdc4e2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dmpl_sample.npz&quot;</span><span class="p">:</span> <span class="s2">&quot;576bb76b2a6328dc5c276c4150c466f0&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">):</span>
        <span class="n">npz_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="s2">&quot;npz&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span>
        <span class="n">npz_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">npz_files</span><span class="p">]</span>
    <span class="n">_md5sums</span> <span class="o">=</span> <span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fpath</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">md5</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="k">for</span> <span class="n">fpath</span> <span class="ow">in</span> <span class="n">npz_paths</span><span class="p">}</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">md5sums</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">md5sums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">_md5sums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Testing that <code>verify=True</code> works as expected. Can redefine <a href="/llamass/core.html#hashes"><code>hashes</code></a> here for testing without breaking the exported library because this cell doesn't get exported by <code>nbdev</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="n">hashes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sample.tar.bz2&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;unpacks_to&quot;</span><span class="p">:</span> <span class="s2">&quot;sample&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="s2">&quot;b5a86fe22ed2799d79101a532eb0ff27&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">unpacking_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">skip_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="k">assert</span> <span class="n">unpacking_time</span> <span class="o">&gt;</span> <span class="n">skip_time</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Loading-Functions">Loading Functions<a class="anchor-link" href="#Loading-Functions"> </a></h1><blockquote><p>Load the pose data directly from the <code>npz</code> files after unpacking.</p>
</blockquote>
<p>Based on the <a href="https://github.com/nghorbani/amass/tree/master/notebooks">AMASS tutorial notebooks</a>, I would like to iterate over the dataset using a PyTorch Dataloader.</p>
<p>Steps to load:1. Index all of the <code>npz</code> files in the AMASS directory2. Iterate through all of them in sequence</p>

<pre><code>1. Load the `npz` file
1. Cut out acceptable motion sequence in center of each file (typically middle 80% of motion sequence)
2. _Optionally_ shuffle the dataset
2. Iterate over this sequence along the first dimension
</code></pre>
<ol>
<li>When running with <code>num_workers &gt; 0</code>, give each worker a different random set of <code>npz</code> files to load</li>
</ol>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Looking at the sample data:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">):</span>
        <span class="n">npz_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="s2">&quot;npz&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span>
        <span class="n">npz_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">npz_files</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">npz_path</span> <span class="ow">in</span> <span class="n">npz_paths</span><span class="p">:</span>
        <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">cdata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>/tmp/tmpos4dxm6z/sample/subdir/amass_sample.npz
   [&#39;poses&#39;, &#39;gender&#39;, &#39;mocap_framerate&#39;, &#39;betas&#39;, &#39;marker_data&#39;, &#39;dmpls&#39;, &#39;marker_labels&#39;, &#39;trans&#39;]
   [(&#39;poses&#39;, (601, 156)), (&#39;gender&#39;, ()), (&#39;mocap_framerate&#39;, ()), (&#39;betas&#39;, (16,)), (&#39;marker_data&#39;, (601, 85, 3)), (&#39;dmpls&#39;, (601, 8)), (&#39;marker_labels&#39;, (85,)), (&#39;trans&#39;, (601, 3))]
/tmp/tmpos4dxm6z/sample/subdir/dmpl_sample.npz
   [&#39;poses&#39;, &#39;gender&#39;, &#39;mocap_framerate&#39;, &#39;betas&#39;, &#39;marker_data&#39;, &#39;dmpls&#39;, &#39;marker_labels&#39;, &#39;trans&#39;]
   [(&#39;poses&#39;, (235, 156)), (&#39;gender&#39;, ()), (&#39;mocap_framerate&#39;, ()), (&#39;betas&#39;, (16,)), (&#39;marker_data&#39;, (235, 67, 3)), (&#39;dmpls&#39;, (235, 8)), (&#39;marker_labels&#39;, (67,)), (&#39;trans&#39;, (235, 3))]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The AMASS dataset is composed of 14,096 <code>.npz</code> archives (at time of writing). The size of archives varies over two orders of magnitude, between 0.1MB and 10MB.</p>
<p><img src="/llamass/./images/amass_file_sizes.png" alt="A histogram of the file sizes in AMASS" title="AMASS File Sizes Histogram"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Other statistics we might want to know:</p>
<ul>
<li>Length of motion sequence in each of these files</li>
<li>...</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="What-do-the-fields-mean?">What do the fields mean?<a class="anchor-link" href="#What-do-the-fields-mean?"> </a></h2><p><img src="/llamass/./images/amass-quote.png" alt="Screenshot quote from the AMASS paper" title="AMASS Quote"></p>
<p>AMASS <code>npz</code> files contain 5 fields (<code>'poses', 'gender', 'betas', 'dmpls', 'trans'</code>), what do they mean?</p>
<ul>
<li><code>poses</code> are <a href="https://mano.is.tue.mpg.de/">SMPLH</a> vectors, which are a representation of pose based on <a href="https://smpl.is.tue.mpg.de/">SMPL</a> with additional information about the positions of the hands. What are SMPLH vectors composed of?<ul>
<li>52 joints, each represented with 3 parameters, 22 for the body and 30 for the hands</li>
<li>Encoded with 3 rotational degrees of freedom as <a href="https://en.wikipedia.org/wiki/Axis%E2%80%93angle_representation">angle-axis rotation vectors</a></li>
</ul>
</li>
<li><code>gender</code> is the reported gender of the actor (it's not clear if MPI has used their <a href="https://github.com/nghorbani/homogenus">gender classifier</a> here)</li>
<li><code>betas</code> are "identity-dependent shape parameters"</li>
<li><code>dmpls</code> are soft tissue deformations described in the <a href="https://files.is.tue.mpg.de/black/papers/SMPL2015.pdf#page=12">original SMPL paper</a></li>
<li><code>trans</code> I think this is the $\gamma$ 3D parameter representing the translation of the root coordinate system, it is required to describe the pose and should probably be concatenated to the pose vector as described in the <a href="https://files.is.tue.mpg.de/black/papers/amass.pdf">AMASS paper</a>.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="npz-File-Iterator"><code>npz</code> File Iterator<a class="anchor-link" href="#npz-File-Iterator"> </a></h2><blockquote><p>Iterates over all the paths of all the <code>npz</code> files in AMASS.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="npz_paths" class="doc_header"><code>npz_paths</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L199" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>npz_paths</code>(<strong><code>npz_directory</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">npz_paths</span><span class="p">(</span><span class="n">npz_directory</span><span class="p">):</span>
    <span class="n">npz_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">npz_directory</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="n">npz_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">npz_directory</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;npz&quot;</span> <span class="o">==</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fname</span> <span class="o">!=</span> <span class="s2">&quot;shape.npz&quot;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">npz_directory</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">npz_path</span> <span class="ow">in</span> <span class="n">npz_paths</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">symlink</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="n">source</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">source</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">source</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">tmpdirname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">symlink</span><span class="p">(</span><span class="n">tmpdirname</span><span class="o">/</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;sym&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">symlink_loc</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">npz_path</span> <span class="ow">in</span> <span class="n">npz_paths</span><span class="p">(</span><span class="n">symlink_loc</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="n">npz_path</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inferring-Dataset-Size">Inferring Dataset Size<a class="anchor-link" href="#Inferring-Dataset-Size"> </a></h2><blockquote><p>A function to calculate dataset size, with the result stored in this package.</p>
</blockquote>
<p>The result of this calculation is stored in this package, the dataset loader will try to load this file or recreate it itself, so you can skip that step by copying it into the directory where you have unpacked the data.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="npz_len" class="doc_header"><code>npz_len</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L208" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>npz_len</code>(<strong><code>npz_path</code></strong>, <strong><code>strict</code></strong>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="npz_lens" class="doc_header"><code>npz_lens</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L222" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>npz_lens</code>(<strong><code>unpacked_directory</code></strong>, <strong><code>n_jobs</code></strong>, <strong><code>strict</code></strong>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="save_lens" class="doc_header"><code>save_lens</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L228" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>save_lens</code>(<strong><code>save_path</code></strong>, <strong><code>npz_file_lens</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">npz_len</span><span class="p">(</span><span class="n">npz_path</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">md5_file</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">hashes</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="s1">&#39;unpacks_to&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hashes</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">+=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">d</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Subdir of </span><span class="si">{</span><span class="n">npz_path</span><span class="si">}</span><span class="s2"> contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">dirs</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">subdir</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">cdata</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">npz_lens</span><span class="p">(</span><span class="n">unpacked_directory</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">npz_paths</span><span class="p">(</span><span class="n">unpacked_directory</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">ProgressParallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)(</span>
        <span class="p">[</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">npz_len</span><span class="p">)(</span><span class="n">npz_path</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span> <span class="k">for</span> <span class="n">npz_path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">],</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">save_lens</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">npz_file_lens</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">npz_file_lens</span><span class="p">))</span>

<span class="c1">#npz_file_lens = npz_lens(&#39;/nobackup/gngdb/repos/amass/data&#39;, 10)</span>
<span class="c1">#save_lens(&#39;npz_file_lens.json.gz&#39;, npz_file_lens)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>du -hs npz_file_lens.json.gz
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>399K	npz_file_lens.json.gz
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Viable-Indexes">Viable Indexes<a class="anchor-link" href="#Viable-Indexes"> </a></h2><p>For every <code>npz</code> file I need to pull out the viable indexes:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="keep_slice" class="doc_header"><code>keep_slice</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L236" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>keep_slice</code>(<strong><code>n</code></strong>, <strong><code>keep</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="viable_slice" class="doc_header"><code>viable_slice</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L241" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>viable_slice</code>(<strong><code>cdata</code></strong>, <strong><code>keep</code></strong>)</p>
</blockquote>
<p>Inspects a dictionary loaded from <code>.npz</code> numpy dumps
and creates a slice of the viable indexes.
args:</p>

<pre><code>- `cdata`: dictionary containing keys:
    ['poses', 'gender', 'mocap_framerate', 'betas',
     'marker_data', 'dmpls', 'marker_labels', 'trans']
- `keep`: ratio of the file to keep, between zero and 1.,
    drops leading and trailing ends of the arrays

</code></pre>
<p>returns:</p>

<pre><code>- viable: slice that can access frames in the arrays:
    cdata['poses'], cdata['marker_data'], cdata['dmpls'], cdata['trans']</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">keep_slice</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">keep</span><span class="p">):</span>
    <span class="n">drop</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">keep</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">drop</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">keep</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">drop</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">viable_slice</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="n">keep</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inspects a dictionary loaded from `.npz` numpy dumps</span>
<span class="sd">    and creates a slice of the viable indexes.</span>
<span class="sd">    args:</span>

<span class="sd">        - `cdata`: dictionary containing keys:</span>
<span class="sd">            [&#39;poses&#39;, &#39;gender&#39;, &#39;mocap_framerate&#39;, &#39;betas&#39;,</span>
<span class="sd">             &#39;marker_data&#39;, &#39;dmpls&#39;, &#39;marker_labels&#39;, &#39;trans&#39;]</span>
<span class="sd">        - `keep`: ratio of the file to keep, between zero and 1.,</span>
<span class="sd">            drops leading and trailing ends of the arrays</span>

<span class="sd">    returns:</span>

<span class="sd">        - viable: slice that can access frames in the arrays:</span>
<span class="sd">            cdata[&#39;poses&#39;], cdata[&#39;marker_data&#39;], cdata[&#39;dmpls&#39;], cdata[&#39;trans&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">keep</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">keep</span> <span class="o">&lt;=</span> <span class="mf">1.0</span>
    <span class="p">),</span> <span class="s2">&quot;Proportion of array to keep must be between zero and one&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">cdata</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">keep_slice</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">keep</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">npz_path</span> <span class="ow">in</span> <span class="n">npz_paths</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">):</span>
        <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="n">viable_slice</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>/tmp/tmpas2sa5g4/sample/subdir/amass_sample.npz
   slice(60, 540, None)
/tmp/tmpas2sa5g4/sample/subdir/dmpl_sample.npz
   slice(23, 211, None)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="npz-Contents-Iterator"><code>npz</code> Contents Iterator<a class="anchor-link" href="#npz-Contents-Iterator"> </a></h2><blockquote><p>Loads an <code>.npz</code> file and iterates over the examples within.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="npz_contents" class="doc_header"><code>npz_contents</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L265" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>npz_contents</code>(<strong><code>npz_path</code></strong>, <strong><code>clip_length</code></strong>, <strong><code>overlapping</code></strong>, <strong><code>keep</code></strong>=<em><code>0.8</code></em>, <strong><code>keys</code></strong>=<em><code>('poses', 'dmpls', 'trans', 'betas', 'gender')</code></em>, <strong><code>shuffle</code></strong>=<em><code>False</code></em>, <strong><code>seed</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">npz_contents</span><span class="p">(</span>
    <span class="n">npz_path</span><span class="p">,</span>
    <span class="n">clip_length</span><span class="p">,</span>
    <span class="n">overlapping</span><span class="p">,</span>
    <span class="n">keep</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">keys</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;poses&quot;</span><span class="p">,</span> <span class="s2">&quot;dmpls&quot;</span><span class="p">,</span> <span class="s2">&quot;trans&quot;</span><span class="p">,</span> <span class="s2">&quot;betas&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">),</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># cache this because we will often be accessing the same file multiple times</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">npz_path</span><span class="p">)</span>

    <span class="c1"># slice of viable indices</span>
    <span class="n">viable</span> <span class="o">=</span> <span class="n">viable_slice</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="n">keep</span><span class="p">)</span>

    <span class="c1"># slice iterator</span>
    <span class="c1"># every time the file is opened the non-overlapping slices will be the same</span>
    <span class="c1"># this may not be preferred, but loading overlapping means a lot of repetitive data</span>
    <span class="k">def</span> <span class="nf">clip_slices</span><span class="p">(</span><span class="n">viable</span><span class="p">,</span> <span class="n">clip_length</span><span class="p">,</span> <span class="n">overlapping</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">overlapping</span> <span class="k">else</span> <span class="n">clip_length</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">viable</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">viable</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">clip_length</span> <span class="o">&lt;</span> <span class="n">viable</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
                <span class="k">yield</span> <span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">clip_length</span><span class="p">)</span>

    <span class="c1"># buffer the iterator and shuffle here, when implementing that</span>
    <span class="n">buf_clip_slices</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">clip_slices</span><span class="p">(</span><span class="n">viable</span><span class="p">,</span> <span class="n">clip_length</span><span class="p">,</span> <span class="n">overlapping</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="c1"># this will be correlated over workers</span>
        <span class="c1"># seed should be passed drawn from torch Generator</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span> <span class="k">if</span> <span class="n">seed</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buf_clip_slices</span><span class="p">)</span>

    <span class="c1"># iterate over slices</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">buf_clip_slices</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># unpack and enforce data type</span>
        <span class="n">to_load</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;poses&quot;</span><span class="p">,</span> <span class="s2">&quot;dmpls&quot;</span><span class="p">,</span> <span class="s2">&quot;trans&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">to_load</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdata</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;betas&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">start</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;betas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                <span class="n">cdata</span><span class="p">[</span><span class="s2">&quot;betas&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">repeats</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;gender&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">gender_to_int</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                <span class="c1"># casting gender to integer will raise a warning in future</span>
                <span class="n">g</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;male&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;neutral&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;female&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}[</span><span class="n">g</span><span class="p">]</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gender&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">gender_to_int</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s2">&quot;gender&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">stop</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="k">yield</span> <span class="n">data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_load_npz</span><span class="p">(</span><span class="n">clip_length</span><span class="p">,</span> <span class="n">overlapping</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
        <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">npz_path</span> <span class="ow">in</span> <span class="n">npz_paths</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">npz_contents</span><span class="p">(</span><span class="n">npz_path</span><span class="p">,</span> <span class="n">clip_length</span><span class="p">,</span> <span class="n">overlapping</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">clip_length</span>
                <span class="k">break</span>


<span class="n">test_load_npz</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">test_load_npz</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">test_load_npz</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[(&#39;poses&#39;, (1, 156)), (&#39;dmpls&#39;, (1, 8)), (&#39;trans&#39;, (1, 3)), (&#39;betas&#39;, (1, 16)), (&#39;gender&#39;, (1,))]
[(&#39;poses&#39;, (1, 156)), (&#39;dmpls&#39;, (1, 8)), (&#39;trans&#39;, (1, 3)), (&#39;betas&#39;, (1, 16)), (&#39;gender&#39;, (1,))]
[(&#39;poses&#39;, (3, 156)), (&#39;dmpls&#39;, (3, 8)), (&#39;trans&#39;, (3, 3)), (&#39;betas&#39;, (3, 16)), (&#39;gender&#39;, (3,))]
[(&#39;poses&#39;, (3, 156)), (&#39;dmpls&#39;, (3, 8)), (&#39;trans&#39;, (3, 3)), (&#39;betas&#39;, (3, 16)), (&#39;gender&#39;, (3,))]
[(&#39;poses&#39;, (3, 156)), (&#39;dmpls&#39;, (3, 8)), (&#39;trans&#39;, (3, 3)), (&#39;betas&#39;, (3, 16)), (&#39;gender&#39;, (3,))]
[(&#39;poses&#39;, (3, 156)), (&#39;dmpls&#39;, (3, 8)), (&#39;trans&#39;, (3, 3)), (&#39;betas&#39;, (3, 16)), (&#39;gender&#39;, (3,))]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="PyTorch-Dataset-Class">PyTorch Dataset Class<a class="anchor-link" href="#PyTorch-Dataset-Class"> </a></h1><blockquote><p>An iterable style PyTorch Dataset class to iterate over all of the <code>.npz</code> files storing motion sequences in a directory.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/nobackup/gngdb/repos/amass/data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[Path(&#39;/nobackup/gngdb/repos/amass/data/val&#39;),
 Path(&#39;/nobackup/gngdb/repos/amass/data/test&#39;),
 Path(&#39;/nobackup/gngdb/repos/amass/data/train&#39;),
 Path(&#39;/nobackup/gngdb/repos/amass/data/train_subset&#39;),
 Path(&#39;/nobackup/gngdb/repos/amass/data/val_subset&#39;)]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AMASS" class="doc_header"><code>class</code> <code>AMASS</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L323" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AMASS</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <code>IterableDataset</code></p>
</blockquote>
<p>An iterable Dataset.</p>
<p>All datasets that represent an iterable of data samples should subclass it.
Such form of datasets is particularly useful when data come from a stream.</p>
<p>All subclasses should overwrite :meth:<code>__iter__</code>, which would return an
iterator of samples in this dataset.</p>
<p>When a subclass is used with :class:<code>~torch.utils.data.DataLoader</code>, each
item in the dataset will be yielded from the :class:<code>~torch.utils.data.DataLoader</code>
iterator. When :attr:<code>num_workers &gt; 0</code>, each worker process will have a
different copy of the dataset object, so it is often desired to configure
each copy independently to avoid having duplicate data returned from the
workers. :func:<code>~torch.utils.data.get_worker_info</code>, when called in a worker
process, returns information about the worker. It can be used in either the
dataset's :meth:<code>__iter__</code> method or the :class:<code>~torch.utils.data.DataLoader</code> 's
:attr:<a href="/llamass/core.html#worker_init_fn"><code>worker_init_fn</code></a> option to modify each copy's behavior.</p>
<p>Example 1: splitting workload across all workers in :meth:<code>__iter__</code>::</p>

<pre><code>&gt;&gt;&gt; class MyIterableDataset(torch.utils.data.IterableDataset):
...     def __init__(self, start, end):
...         super(MyIterableDataset).__init__()
...         assert end &gt; start, "this example code only works with end &gt;= start"
...         self.start = start
...         self.end = end
...
...     def __iter__(self):
...         worker_info = torch.utils.data.get_worker_info()
...         if worker_info is None:  # single-process data loading, return the full iterator
...             iter_start = self.start
...             iter_end = self.end
...         else:  # in a worker process
...             # split workload
...             per_worker = int(math.ceil((self.end - self.start) / float(worker_info.num_workers)))
...             worker_id = worker_info.id
...             iter_start = self.start + worker_id * per_worker
...             iter_end = min(iter_start + per_worker, self.end)
...         return iter(range(iter_start, iter_end))
...
&gt;&gt;&gt; # should give same set of data as range(3, 7), i.e., [3, 4, 5, 6].
&gt;&gt;&gt; ds = MyIterableDataset(start=3, end=7)

&gt;&gt;&gt; # Single-process loading
&gt;&gt;&gt; print(list(torch.utils.data.DataLoader(ds, num_workers=0)))
[3, 4, 5, 6]

&gt;&gt;&gt; # Mult-process loading with two worker processes
&gt;&gt;&gt; # Worker 0 fetched [3, 4].  Worker 1 fetched [5, 6].
&gt;&gt;&gt; print(list(torch.utils.data.DataLoader(ds, num_workers=2)))
[3, 5, 4, 6]

&gt;&gt;&gt; # With even more workers
&gt;&gt;&gt; print(list(torch.utils.data.DataLoader(ds, num_workers=20)))
[3, 4, 5, 6]

</code></pre>
<p>Example 2: splitting workload across all workers using :attr:<a href="/llamass/core.html#worker_init_fn"><code>worker_init_fn</code></a>::</p>

<pre><code>&gt;&gt;&gt; class MyIterableDataset(torch.utils.data.IterableDataset):
...     def __init__(self, start, end):
...         super(MyIterableDataset).__init__()
...         assert end &gt; start, "this example code only works with end &gt;= start"
...         self.start = start
...         self.end = end
...
...     def __iter__(self):
...         return iter(range(self.start, self.end))
...
&gt;&gt;&gt; # should give same set of data as range(3, 7), i.e., [3, 4, 5, 6].
&gt;&gt;&gt; ds = MyIterableDataset(start=3, end=7)

&gt;&gt;&gt; # Single-process loading
&gt;&gt;&gt; print(list(torch.utils.data.DataLoader(ds, num_workers=0)))
[3, 4, 5, 6]
&gt;&gt;&gt;
&gt;&gt;&gt; # Directly doing multi-process loading yields duplicate data
&gt;&gt;&gt; print(list(torch.utils.data.DataLoader(ds, num_workers=2)))
[3, 3, 4, 4, 5, 5, 6, 6]

&gt;&gt;&gt; # Define a [`worker_init_fn`](/llamass/core.html#worker_init_fn) that configures each dataset copy differently
&gt;&gt;&gt; def worker_init_fn(worker_id):
...     worker_info = torch.utils.data.get_worker_info()
...     dataset = worker_info.dataset  # the dataset copy in this worker process
...     overall_start = dataset.start
...     overall_end = dataset.end
...     # configure the dataset to only process the split workload
...     per_worker = int(math.ceil((overall_end - overall_start) / float(worker_info.num_workers)))
...     worker_id = worker_info.id
...     dataset.start = overall_start + worker_id * per_worker
...     dataset.end = min(dataset.start + per_worker, overall_end)
...

&gt;&gt;&gt; # Mult-process loading with the custom [`worker_init_fn`](/llamass/core.html#worker_init_fn)
&gt;&gt;&gt; # Worker 0 fetched [3, 4].  Worker 1 fetched [5, 6].
&gt;&gt;&gt; print(list(torch.utils.data.DataLoader(ds, num_workers=2, worker_init_fn=worker_init_fn)))
[3, 5, 4, 6]

&gt;&gt;&gt; # With even more workers
&gt;&gt;&gt; print(list(torch.utils.data.DataLoader(ds, num_workers=20, worker_init_fn=worker_init_fn)))
[3, 4, 5, 6]</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">AMASS</span><span class="p">(</span><span class="n">tudata</span><span class="o">.</span><span class="n">IterableDataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">amass_location</span><span class="p">,</span>
        <span class="n">clip_length</span><span class="p">,</span>
        <span class="n">overlapping</span><span class="p">,</span>
        <span class="n">keep</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_keys</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;poses&quot;</span><span class="p">,</span> <span class="s2">&quot;dmpls&quot;</span><span class="p">,</span> <span class="s2">&quot;trans&quot;</span><span class="p">,</span> <span class="s2">&quot;betas&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">),</span>
        <span class="n">file_list_seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="n">clip_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">clip_length</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span> <span class="o">=</span> <span class="n">data_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amass_location</span> <span class="o">=</span> <span class="n">amass_location</span>
        <span class="c1"># these should be shuffled but pull shuffle argument out of dataloader worker arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_npz_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">npz_path</span> <span class="k">for</span> <span class="n">npz_path</span> <span class="ow">in</span> <span class="n">npz_paths</span><span class="p">(</span><span class="n">amass_location</span><span class="p">)]</span>
        <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">file_list_seed</span><span class="p">)</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_npz_paths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_npz_paths</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_npz_paths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npz_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_npz_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_length</span> <span class="o">=</span> <span class="n">clip_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlapping</span> <span class="o">=</span> <span class="n">overlapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep</span> <span class="o">=</span> <span class="n">keep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span> <span class="k">if</span> <span class="n">seed</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict</span> <span class="o">=</span> <span class="n">strict</span>

    <span class="k">def</span> <span class="nf">infer_len</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="c1"># uses known dimensions of the npz files in the AMASS dataset to infer the length</span>
        <span class="c1"># with clip_length and overlapping settings stored</span>
        <span class="n">lenfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amass_location</span><span class="p">)</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;npz_file_lens.json.gz&quot;</span><span class="p">)</span>
        <span class="c1"># try to load file</span>
        <span class="k">if</span> <span class="n">lenfile</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">lenfile</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npz_lens</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">filter_lens</span><span class="p">(</span><span class="n">npz_lens</span><span class="p">):</span>
                    <span class="c1"># filter out file length information to only existing dirs</span>
                    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amass_location</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
                    <span class="k">return</span> <span class="p">[(</span><span class="n">p</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">npz_lens</span>
                            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npz_lens</span> <span class="o">=</span> <span class="n">filter_lens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npz_lens</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if it&#39;s not there, recompute it and create the file</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Inspecting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npz_paths</span><span class="p">)</span><span class="si">}</span><span class="s1"> files to determine dataset length&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;, saving the result to </span><span class="si">{</span><span class="n">lenfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npz_lens</span> <span class="o">=</span> <span class="n">npz_lens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amass_location</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strict</span><span class="p">)</span>
            <span class="n">save_lens</span><span class="p">(</span><span class="n">lenfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npz_lens</span><span class="p">)</span>

        <span class="c1"># using stored lengths to infer the total dataset length</span>
        <span class="k">def</span> <span class="nf">lenslice</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlapping</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_length</span><span class="p">)</span>

        <span class="n">N</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">npz_lens</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">keep_slice</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">+=</span> <span class="n">lenslice</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">N</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_len</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npz_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npz_paths</span><span class="p">)</span>
            <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npz_paths</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">npz_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">npz_paths</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">npz_contents</span><span class="p">(</span>
                <span class="n">npz_path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clip_length</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">overlapping</span><span class="p">,</span>
                <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span><span class="p">,</span>
                <span class="n">keep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># increment to vary shuffle over files</span>
                <span class="k">yield</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test I can load some data with this Dataset:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">amass</span> <span class="o">=</span> <span class="n">AMASS</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">amass</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">amass</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>poses torch.Size([1, 156])
dmpls torch.Size([1, 8])
trans torch.Size([1, 3])
betas torch.Size([1, 16])
gender torch.Size([1])
Inspecting 2 files to determine dataset length, saving the result to /tmp/tmpleow1ugq/npz_file_lens.json.gz
668
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test it works in a DataLoader to make batches:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
    <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">amass</span> <span class="o">=</span> <span class="n">AMASS</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">)</span>
    <span class="n">amasstrain</span> <span class="o">=</span> <span class="n">tudata</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">amass</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">amasstrain</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">break</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>poses torch.Size([4, 1, 156])
dmpls torch.Size([4, 1, 8])
trans torch.Size([4, 1, 3])
betas torch.Size([4, 1, 16])
gender torch.Size([4, 1])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Multi-process-Data-Loading">Multi-process Data Loading<a class="anchor-link" href="#Multi-process-Data-Loading"> </a></h2><blockquote><p>To work with <code>num_workers &gt; 0</code> I'm going to pass a different set of <code>npz</code> files to each worker using a <a href="/llamass/core.html#worker_init_fn"><code>worker_init_fn</code></a>.</p>
</blockquote>
<p>The following <a href="/llamass/core.html#worker_init_fn"><code>worker_init_fn</code></a> must <strong>always</strong> be used when using <code>num_workers &gt; 0</code> or data will be duplicated. To simplify I am providing a DataLoader class that bakes this <a href="/llamass/core.html#worker_init_fn"><code>worker_init_fn</code></a> in when <code>num_workers &gt; 0</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="worker_init_fn" class="doc_header"><code>worker_init_fn</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L412" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>worker_init_fn</code>(<strong><code>worker_id</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="IterableLoader" class="doc_header"><code>class</code> <code>IterableLoader</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L432" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>IterableLoader</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <code>DataLoader</code></p>
</blockquote>
<p>Data loader. Combines a dataset and a sampler, and provides an iterable over
the given dataset.</p>
<p>The :class:<code>~torch.utils.data.DataLoader</code> supports both map-style and
iterable-style datasets with single- or multi-process loading, customizing
loading order and optional automatic batching (collation) and memory pinning.</p>
<p>See :py:mod:<code>torch.utils.data</code> documentation page for more details.</p>
<p>Args:
    dataset (Dataset): dataset from which to load the data.
    batch_size (int, optional): how many samples per batch to load
        (default: <code>1</code>).
    shuffle (bool, optional): set to <code>True</code> to have the data reshuffled
        at every epoch (default: <code>False</code>).
    sampler (Sampler or Iterable, optional): defines the strategy to draw
        samples from the dataset. Can be any <code>Iterable</code> with <code>__len__</code>
        implemented. If specified, :attr:<code>shuffle</code> must not be specified.
    batch_sampler (Sampler or Iterable, optional): like :attr:<code>sampler</code>, but
        returns a batch of indices at a time. Mutually exclusive with
        :attr:<code>batch_size</code>, :attr:<code>shuffle</code>, :attr:<code>sampler</code>,
        and :attr:<code>drop_last</code>.
    num_workers (int, optional): how many subprocesses to use for data
        loading. <code>0</code> means that the data will be loaded in the main process.
        (default: <code>0</code>)
    collate_fn (callable, optional): merges a list of samples to form a
        mini-batch of Tensor(s).  Used when using batched loading from a
        map-style dataset.
    pin_memory (bool, optional): If <code>True</code>, the data loader will copy Tensors
        into CUDA pinned memory before returning them.  If your data elements
        are a custom type, or your :attr:<code>collate_fn</code> returns a batch that is a custom type,
        see the example below.
    drop_last (bool, optional): set to <code>True</code> to drop the last incomplete batch,
        if the dataset size is not divisible by the batch size. If <code>False</code> and
        the size of dataset is not divisible by the batch size, then the last batch
        will be smaller. (default: <code>False</code>)
    timeout (numeric, optional): if positive, the timeout value for collecting a batch
        from workers. Should always be non-negative. (default: <code>0</code>)
    worker_init_fn (callable, optional): If not <code>None</code>, this will be called on each
        worker subprocess with the worker id (an int in <code>[0, num_workers - 1]</code>) as
        input, after seeding and before data loading. (default: <code>None</code>)
    generator (torch.Generator, optional): If not <code>None</code>, this RNG will be used
        by RandomSampler to generate random indexes and multiprocessing to generate
        <code>base_seed</code> for workers. (default: <code>None</code>)
    prefetch_factor (int, optional, keyword-only arg): Number of samples loaded
        in advance by each worker. <code>2</code> means there will be a total of
        2 * num_workers samples prefetched across all workers. (default: <code>2</code>)
    persistent_workers (bool, optional): If <code>True</code>, the data loader will not shutdown
        the worker processes after a dataset has been consumed once. This allows to
        maintain the workers <code>Dataset</code> instances alive. (default: <code>False</code>)</p>
<p>.. warning:: If the <code>spawn</code> start method is used, :attr:<a href="/llamass/core.html#worker_init_fn"><code>worker_init_fn</code></a>
             cannot be an unpicklable object, e.g., a lambda function. See
             :ref:<code>multiprocessing-best-practices</code> on more details related
             to multiprocessing in PyTorch.</p>
<p>.. warning:: <code>len(dataloader)</code> heuristic is based on the length of the sampler used.
             When :attr:<code>dataset</code> is an :class:<code>~torch.utils.data.IterableDataset</code>,
             it instead returns an estimate based on <code>len(dataset) / batch_size</code>, with proper
             rounding depending on :attr:<code>drop_last</code>, regardless of multi-process loading
             configurations. This represents the best guess PyTorch can make because PyTorch
             trusts user :attr:<code>dataset</code> code in correctly handling multi-process
             loading to avoid duplicate data.</p>

<pre><code>         However, if sharding results in multiple workers having incomplete last batches,
         this estimate can still be inaccurate, because (1) an otherwise complete batch can
         be broken into multiple ones and (2) more than one batch worth of samples can be
         dropped when :attr:`drop_last` is set. Unfortunately, PyTorch can not detect such
         cases in general.

         See `Dataset Types`_ for more details on these two types of datasets and how
         :class:`~torch.utils.data.IterableDataset` interacts with
         `Multi-process data loading`_.

</code></pre>
<p>.. warning:: See :ref:<code>reproducibility</code>, and :ref:<code>dataloader-workers-random-seed</code>, and
             :ref:<code>data-loading-randomness</code> notes for random seed related questions.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">worker_init_fn</span><span class="p">(</span><span class="n">worker_id</span><span class="p">):</span>
    <span class="n">worker_info</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_worker_info</span><span class="p">()</span>

    <span class="c1"># slice up dataset among workers</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">worker_info</span><span class="o">.</span><span class="n">dataset</span>
    <span class="n">overall_npz_paths</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_npz_paths</span>
    <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">overall_npz_paths</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">worker_info</span><span class="o">.</span><span class="n">num_workers</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">overall_npz_paths</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">worker_info</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;Every worker must get at least one file:&quot;</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">worker_info</span><span class="o">.</span><span class="n">num_workers</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span>
    <span class="k">for</span> <span class="n">worker_idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">worker_idx</span> <span class="o">==</span> <span class="n">worker_info</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="n">worker_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">npz_paths</span> <span class="o">=</span> <span class="n">overall_npz_paths</span><span class="p">[</span><span class="n">worker_slice</span><span class="p">]</span>

    <span class="c1"># set each workers seed</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">seed</span> <span class="o">+</span> <span class="n">worker_info</span><span class="o">.</span><span class="n">seed</span>

<span class="k">class</span> <span class="nc">IterableLoader</span><span class="p">(</span><span class="n">tudata</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;worker_init_fn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">worker_init_fn</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_dataloader</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
        <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">amass</span> <span class="o">=</span> <span class="n">AMASS</span><span class="p">(</span>
            <span class="n">tmpdirname</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span>
        <span class="p">)</span>
        <span class="n">amasstrain</span> <span class="o">=</span> <span class="n">tudata</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">amass</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">worker_init_fn</span><span class="o">=</span><span class="n">worker_init_fn</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">amasstrain</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">break</span>
        <span class="n">amasstrain</span> <span class="o">=</span> <span class="n">IterableLoader</span><span class="p">(</span>
            <span class="n">amass</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">amasstrain</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">break</span>

<span class="n">test_dataloader</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>poses torch.Size([4, 1, 156])
dmpls torch.Size([4, 1, 8])
trans torch.Size([4, 1, 3])
betas torch.Size([4, 1, 16])
gender torch.Size([4, 1])
poses torch.Size([4, 1, 156])
dmpls torch.Size([4, 1, 8])
trans torch.Size([4, 1, 3])
betas torch.Size([4, 1, 16])
gender torch.Size([4, 1])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_runtime</span><span class="p">(</span><span class="n">unpacked_dir</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="p">):</span>
    <span class="n">amass</span> <span class="o">=</span> <span class="n">AMASS</span><span class="p">(</span>
        <span class="n">unpacked_dir</span><span class="p">,</span> <span class="n">overlapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">amasstrain</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">amass</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">worker_init_fn</span><span class="o">=</span><span class="n">worker_init_fn</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span>
    <span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">amasstrain</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">total_hours</span> <span class="o">=</span> <span class="p">((</span><span class="n">elapsed</span> <span class="o">/</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">amasstrain</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">elapsed</span> <span class="o">/</span> <span class="n">i</span><span class="p">,</span> <span class="n">total_hours</span>


<span class="c1"># test_runtime(&#39;/nobackup/gngdb/repos/amass/data&#39;, 256, 8)</span>
<span class="c1"># test_runtime(&#39;/scratch/gobi1/gngdb/amass&#39;, 256, 8)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Rough results from testing runtime on full dataset on my workstation:</p>
<ul>
<li>Batch size 32:<ul>
<li>0: 260ms/batch, 35 hours per epoch</li>
<li>2: 91ms/batch, 12 hours per epoch</li>
<li>4: 58ms/batch, 7 hours 54 minutes per epoch</li>
<li>8: 29ms/batch, 4 hours per epoch</li>
<li>12 (number of cores): 3 hours 45 minutes per epoch</li>
</ul>
</li>
<li>Batch size 256:<ul>
<li>0: 910ms/batch, 16 hours per epoch</li>
<li>2: 816ms/batch, 14 hours per epoch</li>
<li>4: 457ms/batch, 8 hours per epoch</li>
<li>8: 235ms/batch, 4 hours per epoch</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Shuffling">Shuffling<a class="anchor-link" href="#Shuffling"> </a></h2><p>PyTorch DataLoaders don't support shuffling IterableDataset because it's assuming the data is coming in as an IID stream. For this problem, this means the shuffling has to be implemented elsewhere.</p>
<p>There are two parts to shuffle:</p>
<ul>
<li>The indexes accessing the arrays in each file</li>
<li>The list of files to access</li>
</ul>
<p>The first is easy and can be an option to the iterator over each file. It doesn't affect how each worker operates because no two workers should ever touch the same file.</p>
<p>The second is more difficult because each worker has a different list of files. Also, it's important that the order of the global list of files be random, because some files are larger than others and the randomness is to ensure that each worker has approximately the same number of examples in the files it has received. However, every worker initialises a separate dataset, so each dataset has to have access to the same list of files. I think the best way to ensure this at this point is to use a shared random seed to shuffle the list of files at initialisation.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_shuffling</span><span class="p">(</span><span class="n">num_workers</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
        <span class="n">unpack_body_models</span><span class="p">(</span><span class="s2">&quot;sample_data/&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">amass</span> <span class="o">=</span> <span class="n">AMASS</span><span class="p">(</span>
            <span class="n">tmpdirname</span><span class="p">,</span>
            <span class="n">overlapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clip_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">amasstrain</span> <span class="o">=</span> <span class="n">tudata</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">amass</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">worker_init_fn</span><span class="o">=</span><span class="n">worker_init_fn</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">amasstrain</span><span class="p">):</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="c1"># second epoch shouldn&#39;t produce the same minibatch</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">amasstrain</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;poses&quot;</span><span class="p">]</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">_data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">_data</span><span class="p">)</span>
            <span class="k">break</span>


<span class="k">for</span> <span class="n">num_workers</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">test_shuffling</span><span class="p">(</span><span class="n">num_workers</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Train/test-Splits">Train/test Splits<a class="anchor-link" href="#Train/test-Splits"> </a></h1><blockquote><p>Console utility to split directories in a standard way</p>
</blockquote>
<p>The original preprocessing script splits directories <a href="https://github.com/nghorbani/amass/blob/master/src/amass/data/prepare_data.py#L235-L239">the following way</a>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">original_amass_splits</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;val&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;HumanEva&#39;</span><span class="p">,</span> <span class="s1">&#39;MPI_HDM05&#39;</span><span class="p">,</span> <span class="s1">&#39;SFU&#39;</span><span class="p">,</span> <span class="s1">&#39;MPI_mosh&#39;</span><span class="p">],</span>
    <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Transitions_mocap&#39;</span><span class="p">,</span> <span class="s1">&#39;SSM_synced&#39;</span><span class="p">],</span>
    <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;CMU&#39;</span><span class="p">,</span> <span class="s1">&#39;MPI_Limits&#39;</span><span class="p">,</span> <span class="s1">&#39;TotalCapture&#39;</span><span class="p">,</span> <span class="s1">&#39;Eyes_Japan_Dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;KIT&#39;</span><span class="p">,</span> <span class="s1">&#39;BML&#39;</span><span class="p">,</span> <span class="s1">&#39;EKUT&#39;</span><span class="p">,</span> <span class="s1">&#39;TCD_handMocap&#39;</span><span class="p">,</span> <span class="s1">&#39;ACCAD&#39;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This doesn't allocated all the datasets composing AMASS to a split:</p>

<pre><code>Datasets not allocated to a split: {'BMLmovi', 'BioMotionLab_NTroje', 'DanceDB', 'BMLhandball', 'DFaust_67'}</code></pre>
<p>Obtained by evaluating the following cell on an unpacked directory of AMASS data:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">unallocated_splits</span><span class="p">(</span><span class="n">unpacked_dir</span><span class="p">):</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">unpacked_dir</span><span class="p">)</span>
    <span class="n">all_subdirs</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">data_path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()}</span>
    <span class="n">unallocated</span> <span class="o">=</span> <span class="n">all_subdirs</span> <span class="o">-</span> <span class="p">{</span><span class="n">d</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">amass_splits</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">amass_splits</span><span class="p">[</span><span class="n">k</span><span class="p">]}</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Datasets not allocated to a split: </span><span class="si">{</span><span class="n">unallocated</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># unallocated_splits(&#39;/nobackup/gngdb/repos/amass/data&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I'm going to include all the newer datasets in the training set.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">amass_splits</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;val&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;HumanEva&#39;</span><span class="p">,</span> <span class="s1">&#39;MPI_HDM05&#39;</span><span class="p">,</span> <span class="s1">&#39;SFU&#39;</span><span class="p">,</span> <span class="s1">&#39;MPI_mosh&#39;</span><span class="p">],</span>
    <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Transitions_mocap&#39;</span><span class="p">,</span> <span class="s1">&#39;SSM_synced&#39;</span><span class="p">],</span>
    <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;CMU&#39;</span><span class="p">,</span> <span class="s1">&#39;MPI_Limits&#39;</span><span class="p">,</span> <span class="s1">&#39;TotalCapture&#39;</span><span class="p">,</span> <span class="s1">&#39;Eyes_Japan_Dataset&#39;</span><span class="p">,</span>
              <span class="s1">&#39;KIT&#39;</span><span class="p">,</span> <span class="s1">&#39;BML&#39;</span><span class="p">,</span> <span class="s1">&#39;EKUT&#39;</span><span class="p">,</span> <span class="s1">&#39;TCD_handMocap&#39;</span><span class="p">,</span> <span class="s1">&#39;ACCAD&#39;</span><span class="p">,</span>
              <span class="s1">&#39;BMLmovi&#39;</span><span class="p">,</span> <span class="s1">&#39;BioMotionLab_NTroje&#39;</span><span class="p">,</span> <span class="s1">&#39;DanceDB&#39;</span><span class="p">,</span> <span class="s1">&#39;BMLhandball&#39;</span><span class="p">,</span> <span class="s1">&#39;DFaust_67&#39;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>These functions move the directories into subdirectories that define the splits and undo this change.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="move_dirs_into_splits" class="doc_header"><code>move_dirs_into_splits</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L447" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>move_dirs_into_splits</code>(<strong><code>amass_loc</code></strong>, <strong><code>splits</code></strong>, <strong><code>undo</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">move_dirs_into_splits</span><span class="p">(</span><span class="n">amass_loc</span><span class="p">,</span> <span class="n">splits</span><span class="p">,</span> <span class="n">undo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">amass_loc</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">amass_loc</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">amass_splits</span><span class="p">:</span>
        <span class="n">split_dir</span> <span class="o">=</span> <span class="n">amass_loc</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">split_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">split_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">amass_splits</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">split_dir</span><span class="o">/</span><span class="n">d</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">amass_loc</span><span class="o">/</span><span class="n">d</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">undo</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> split&#39;</span><span class="p">)</span>
    
<span class="n">move_dirs_out_of_splits</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">move_dirs_into_splits</span><span class="p">,</span> <span class="n">undo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="console_split_dirs" class="doc_header"><code>console_split_dirs</code><a href="https://github.com/gngdb/llamass/tree/master/llamass/core.py#L468" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>console_split_dirs</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">console_split_dirs</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Split AMASS Dataset subdirs into train/val/test&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;amassloc&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Location where AMASS has been unpacked&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--undo&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Undo move into subdirectories, put them all back in the root AMASS location&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">move_dirs_into_splits</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">amassloc</span><span class="p">,</span> <span class="n">amass_splits</span><span class="p">,</span> <span class="n">undo</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">undo</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="SPL-Train/Validation/Test">SPL Train/Validation/Test<a class="anchor-link" href="#SPL-Train/Validation/Test"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="n">train_url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/eth-ait/spl/master/preprocessing/training_fnames.txt&quot;</span>
<span class="n">val_url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/eth-ait/spl/master/preprocessing/validation_fnames.txt&quot;</span>
<span class="n">test_url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/eth-ait/spl/master/preprocessing/test_fnames.txt&quot;</span>

<span class="n">splits</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_url</span><span class="p">,</span> <span class="n">val_url</span><span class="p">,</span> <span class="n">test_url</span><span class="p">]:</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">splits</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_list</span>

<span class="k">for</span> <span class="n">split</span><span class="p">,</span> <span class="n">file_list</span> <span class="ow">in</span> <span class="n">splits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="s2">&quot; = &quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>training  =  {&#39;&#39;, &#39;CMU&#39;, &#39;Transition&#39;, &#39;ACCAD&#39;, &#39;SSM&#39;, &#39;BioMotion&#39;, &#39;JointLimit&#39;, &#39;HEva&#39;, &#39;MIXAMO&#39;, &#39;HDM05&#39;, &#39;CMU_Kitchen&#39;, &#39;Eyes&#39;}
validation  =  {&#39;&#39;, &#39;CMU&#39;, &#39;Transition&#39;, &#39;ACCAD&#39;, &#39;SSM&#39;, &#39;BioMotion&#39;, &#39;JointLimit&#39;, &#39;MIXAMO&#39;, &#39;HDM05&#39;, &#39;Eyes&#39;}
test  =  {&#39;&#39;, &#39;CMU&#39;, &#39;Transition&#39;, &#39;ACCAD&#39;, &#39;BioMotion&#39;, &#39;JointLimit&#39;, &#39;HEva&#39;, &#39;MIXAMO&#39;, &#39;HDM05&#39;, &#39;CMU_Kitchen&#39;, &#39;Eyes&#39;}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">spl_splits</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">training</span>  <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;CMU_Kitchen&#39;</span><span class="p">,</span> <span class="s1">&#39;Eyes&#39;</span><span class="p">,</span> <span class="s1">&#39;HEva&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;MIXAMO&#39;</span><span class="p">,</span> <span class="s1">&#39;Transition&#39;</span><span class="p">,</span> <span class="s1">&#39;CMU&#39;</span><span class="p">,</span> <span class="s1">&#39;SSM&#39;</span><span class="p">,</span> <span class="s1">&#39;BioMotion&#39;</span><span class="p">,</span> <span class="s1">&#39;JointLimit&#39;</span><span class="p">,</span> <span class="s1">&#39;ACCAD&#39;</span><span class="p">,</span> <span class="s1">&#39;HDM05&#39;</span><span class="p">},</span>
    <span class="n">validation</span>  <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;Eyes&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;MIXAMO&#39;</span><span class="p">,</span> <span class="s1">&#39;Transition&#39;</span><span class="p">,</span> <span class="s1">&#39;CMU&#39;</span><span class="p">,</span> <span class="s1">&#39;SSM&#39;</span><span class="p">,</span> <span class="s1">&#39;BioMotion&#39;</span><span class="p">,</span> <span class="s1">&#39;JointLimit&#39;</span><span class="p">,</span> <span class="s1">&#39;ACCAD&#39;</span><span class="p">,</span> <span class="s1">&#39;HDM05&#39;</span><span class="p">},</span>
    <span class="n">test</span>  <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;CMU_Kitchen&#39;</span><span class="p">,</span> <span class="s1">&#39;Eyes&#39;</span><span class="p">,</span> <span class="s1">&#39;HEva&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;MIXAMO&#39;</span><span class="p">,</span> <span class="s1">&#39;Transition&#39;</span><span class="p">,</span> <span class="s1">&#39;CMU&#39;</span><span class="p">,</span> <span class="s1">&#39;BioMotion&#39;</span><span class="p">,</span> <span class="s1">&#39;JointLimit&#39;</span><span class="p">,</span> <span class="s1">&#39;ACCAD&#39;</span><span class="p">,</span> <span class="s1">&#39;HDM05&#39;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># iterate over every subdirectory in AMASS and open the json files containing information on file sizes</span>
<span class="n">amass_loc</span> <span class="o">=</span> <span class="s2">&quot;/nobackup/gngdb/repos/amass/data/&quot;</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">amass_loc</span><span class="p">)</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">npz_len_file</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="s2">&quot;npz_file_lens.json.gz&quot;</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">npz_len_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">stem</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">splits</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;train_subset&#39;</span><span class="p">,</span> <span class="s1">&#39;val_subset&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">]]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">splits</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
        <span class="n">subtotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subtotal</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="mf">100.</span><span class="o">*</span><span class="n">subtotal</span><span class="o">/</span><span class="n">total</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[&#39;train_subset&#39;, &#39;val_subset&#39;]
   train_subset 41220/102240 = 40.32%
   val_subset 61020/102240 = 59.68%
[&#39;val&#39;, &#39;test&#39;, &#39;train&#39;]
   val 1320126/19775902 = 6.68%
   test 117679/19775902 = 0.60%
   train 18338097/19775902 = 92.73%
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

