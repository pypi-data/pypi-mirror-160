{% extends 'psu_base/layout/main.html' %}
{% load base_taglib %}
{% load infotext_taglib %}

{% block title %}Edit Infotext{% endblock %}
{% block scripts %}
    <!-- Summernote requirements -->
    <link href="{%static_content_url%}/wdt/summernote/summernote-0.8.18/summernote-lite.min.css" rel="stylesheet" type="text/css">
    <script src="{%static_content_url%}/wdt/summernote/summernote-0.8.18/summernote-lite.min.js"></script>
    <!-- End of Summernote requirements -->
{% endblock %}

{% block pagecontent %}

    <h1>Infotext for {%app_name%}</h1>

    <form method="get" class="float-right">
        <label for="keywords" class="sr-only">Search for text:</label>
        <div class="input-group mb-3">
          <input type="text" name="keywords" id="keywords" class="form-control" value="{{keywords|default:''}}" placeholder="Search Infotext" />
          <div class="input-group-append">
            <button class="btn btn-info" type="submit">{%fa fa-search title="Search Infotext"%}</button>
          </div>
        </div>
    </form><br style="clear:both;" />
    <br />

    <table class="table table-condensed">
        <tr class="sr-only">
            <th scope="col" class="hidden">ID</th>
            <th scope="col">Actions</th>
            <th scope="col">Identifier</th>
            <th scope="col">Content</th>
        </tr>
        {% for group_title, text_instances in results.items %}
            <tr style="background-color:#A1A58D;">
                <td colspan="3"><h2>{{group_title}}</h2></td>
            </tr>
            {% for it in text_instances %}
            <tr class="it-row">
                <td class="it-id hidden">{{it.id}}</td>
                <td class="it-code">
                    {{it.text_code}}
                    {%if is_developer%}
                    <br />
                    <input type="text" id="group-{{it.id}}" placeholder="Group Title" value="{{it.group_title|default:''}}" class="form-control" onchange="update_group($(this));" />
                    {%endif%}
                </td>
                <td>
                    {%fa fa-pencil-square-o fa-fw text-info title="Edit" onclick="enable_edit($(this));"%}<br />
                    {%fa fa-trash-o fa-fw text-danger title="Delete" onclick="delete_infotext($(this));"%}
                </td>
                <td class="it-content">
                    <div class="it-readonly">{{it.content|safe}}</div>
                    <div class="it-editable hidden">
                        <div class="summernote">{{it.content|safe}}</div>
                    </div>

                </td>
            </tr>
            {% endfor %}
        {% endfor %}
    </table>

    <script type="text/javascript">
        function enable_edit(el){
            let tr = el.closest('tr');
            tr.find('.it-editable').removeClass('hidden');
            tr.find('.it-readonly').addClass('hidden');
            el.addClass('hidden');
        }

        var SaveButton = function(context) {
          var ui = $.summernote.ui;
          var button = ui.button({
            contents: '<i class="fa fa-floppy-o"/> Save',
            tooltip: 'Save text changes',
            click: function() {

                editable = context.$note.closest('tr').find('.note-editable');
                content = editable.html();
                update_infotext(content, editable)

            }
          });

          return button.render();
        }

        $(document).ready(function() {
            $('.summernote').summernote({
                toolbar: [
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['font', ['strikethrough', 'superscript', 'subscript']],
                    ['fontsize', ['fontsize']],
                    ['fontname', ['fontname']],
                    ['color', ['color']],
                    ['insert', ['link', 'picture', 'table']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['view', ['fullscreen', 'codeview', 'help']],
                    ['height', ['height']],
                    ['save', ['save']]
                ],
                buttons: {
                  save: SaveButton
                },
                codeviewIframeFilter: true,
                width: '100%',
                theme: 'lite',
                // airMode: true,
                callbacks: {
                    onChange: function(content, $editable) {
                        let row = $editable.closest('.it-row');
                        let original_text = row.find('.summernote').html();
                        let editable_text_container = row.find('.note-editable');
                        let save_button = row.find('.fa-floppy-o').parent();

                        if(content === original_text){
                            save_button.css('border', '1px solid #dae0e5');
                            editable_text_container.css('background-color', 'inherit');
                        }
                        else{
                            save_button.css('border', '3px solid orange');
                            editable_text_container.css('background-color', '#EBE3C6');
                        }
                    }
                }
            });
        });


        function update_infotext(content, element){
            let row = element.closest('.it-row');
            let saveButton = row.find('.fa-floppy-o').parent();
            let originalTextContainer = row.find('.summernote');
            let editableTextContainer = row.find('.note-editable');
            let id = row.find('.it-id').html();
            $.ajax({
                type:   "POST",
                url:    "{% url 'infotext:update' %}",
                data:   { id: id, content: content, csrfmiddlewaretoken: '{{ csrf_token }}' },
                beforeSend:function(){
                    saveButton.after(getAjaxLoadImage());
                    editableTextContainer.css('background-color', '#EBE3C6');
                },
                success:function(data){
                    //Update original text (not displayed)
                    originalTextContainer.html(data);
                    //Ensure editable content matches (if modified server-side)
                    editableTextContainer.html(data);
                    saveButton.css('border', '1px solid green');
                    flash_success(editableTextContainer)

                },
                error:function(){
                    saveButton.css('border', '1px solid red');
                    editableTextContainer.css('background-color', '#F3DDDF');
                },
                complete:function(){
                    clearAjaxLoadImage(saveButton.parent());
                }
            });
        }

        function delete_infotext(element){
            {%js_confirm column_class="medium" icon="fa-trash-o" title="Delete Infotext" confirm="Delete" cancel="Cancel" onconfirm="_delete_infotext(element);"%}
                Are you sure you want to delete this text?<br />
                <br />
                <em>
                    Note: If the text is still in use, it will be automatically re-created with its default content.
                </em>
            {%end_js_confirm%}
        }
        function _delete_infotext(element){
            let row = element.closest('.it-row');
            let id = row.find('.it-id').html();
            $.ajax({
                type:   "POST",
                url:    "{% url 'infotext:delete' %}",
                data:   { id: id, csrfmiddlewaretoken: '{{ csrf_token }}' },
                beforeSend:function(){
                    element.after(getAjaxLoadImage());
                },
                success:function(data){
                    row.remove();
                },
                error:function(){

                },
                complete:function(){
                    clearAjaxLoadImage(row);
                }
            });
        }


        function update_group(el){
            let row = el.closest('.it-row');
            let group_title = el.val();
            let id = row.find('.it-id').html();
            $.ajax({
                type:   "POST",
                url:    "{% url 'infotext:group' %}",
                data:   { id: id, group_title: group_title, csrfmiddlewaretoken: '{{ csrf_token }}' },
                beforeSend:function(){
                    el.addClass('ajax-pending');
                    clearAjaxStatusClasses(row);
                },
                success:function(data){
                    el.removeClass('ajax-pending');
                    el.addClass('ajax-success');
                },
                error:function(){
                    el.removeClass('ajax-pending');
                    el.addClass('ajax-error');
                },
                complete:function(){
                }
            });
        }

    </script>
    <style>
        .note-save{
            float: right;
        }
    </style>
{% endblock %}
